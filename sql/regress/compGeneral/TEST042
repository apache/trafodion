-- Test: TEST042 (CompGeneral)
-- Functionality: It tests the hybrid query cache feature.
-- Table created: t042_orderline
-- Expected files: EXPECTED042
-- Limitations:
-- Revision history:
--     (08/04/2014) - Created.
--
-- @@@ START COPYRIGHT @@@
--
-- (C) Copyright 2002-2014 Hewlett-Packard Development Company, L.P.
--
--  Licensed under the Apache License, Version 2.0 (the "License");
--  you may not use this file except in compliance with the License.
--  You may obtain a copy of the License at
--
--      http://www.apache.org/licenses/LICENSE-2.0
--
--  Unless required by applicable law or agreed to in writing, software
--  distributed under the License is distributed on an "AS IS" BASIS,
--  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
--  See the License for the specific language governing permissions and
--  limitations under the License.
--
-- @@@ END COPYRIGHT @@@

sh sqlci -i "TEST042(test_ddl)" ;
obey TEST042(test_dml);
exit;

?section test_ddl
create schema TRAFODION.ORDERENTRY;
set schema TRAFODION.ORDERENTRY;
drop table t042_ORDERLINE;
create table t042_ORDERLINE
  (
    OL_O_ID                          INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_D_ID                          INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_W_ID                          INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_NUMBER                        INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_I_ID                          INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_SUPPLY_W_ID                   INT NO DEFAULT NOT NULL NOT DROPPABLE
  , OL_DELIVERY_D                    TIMESTAMP(6) DEFAULT NULL
  , OL_QUANTITY                      NUMERIC(2, 0) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , OL_AMOUNT                        NUMERIC(6, 2) NO DEFAULT NOT NULL NOT
      DROPPABLE
  , OL_DIST_INFO                     CHAR(24) CHARACTER SET ISO88591 COLLATE
      DEFAULT NO DEFAULT NOT NULL NOT DROPPABLE
  , PRIMARY KEY (OL_W_ID ASC, OL_D_ID ASC, OL_O_ID ASC, OL_NUMBER ASC)
  )
  SALT USING 8 PARTITIONS
       ON (OL_W_ID)
;

insert into t042_orderline
values
(1,10,3,1,38994,3,timestamp '2027-11-26 18:11:34.00',5,0,'chuwgjxIpnypxU[YfcxPhUBF'),
(1,10,3,2,16909,3,timestamp '2026-12-18 01:12:15.00',5,0,'nkuftmCZosGnTOEDeeHniXPl'),
(1,10,3,3,75288,3,timestamp '2001-06-20 01:06:58.00',5,0,'ejOFCzrytcrSqNOrOjZ{{yLH'),
(1,10,3,4,17362,3,timestamp '2026-05-25 20:05:09.00',5,0,'Yr[mwMsXouLnDgQH{MIXdsyO'),
(2,10,3,5,93745,3,timestamp '2009-02-03 15:02:17.00',5,0,'JqdrpThOBHRwqbMEJIVXGmKu'),
(2,10,3,6,68201,3,timestamp '1973-12-24 12:12:02.00',5,0,'DoIQoqGSfRX{UDPwXhLRwkSw'),
(2,10,3,1,57108,3,timestamp '2002-06-25 12:06:46.00',5,0,'MnEboHclGwXFSXp{pqeDLtbo'),
(3,10,3,2,92861,3,timestamp '2032-08-09 05:08:58.00',5,0,'MC{juFoKVMnIYqecIEiMl[HH'),
(3,10,3,3,44744,3,timestamp '2027-10-15 09:10:27.00',5,0,'{{rts[zOMuPPrWNmIQdy[eBh'),
(9,10,3,4,44466,3,timestamp '1979-10-17 07:10:53.00',5,0,'LsDxFlXHBuSBTzPkLZTMjRVD');


cqd HIST_LOW_UEC_THRESHOLD '1';

update statistics for table t042_orderline on every column generate 1 intervals;

?section test_dml
set schema TRAFODION.ORDERENTRY;
log LOG042 clear;
showstats for table t042_orderline on ol_o_id detail;

cqd HYBRID_QUERY_CACHE 'off';
-- avoid caching the metadata queries
prepare xx from select * from t042_orderline ;

cqd HQC_LOG 'on';
cqd HQC_LOG_FILE 'hqc.log';
cqd HYBRID_QUERY_CACHE 'on';
cqd QUERY_CACHE_USE_CONVDOIT_FOR_BACKPATCH 'ON';

prepare xx from select * from t042_orderline where ol_o_id = 1 ;
explain options 'f' xx;
execute xx;

prepare xx from select * from t042_orderline where ol_o_id = 2 ;
explain options 'f' xx;
execute xx;

prepare xx from select * from t042_orderline where ol_o_id = 3 ;
explain options 'f' xx;
execute xx;

prepare xx from select * from t042_orderline where ol_o_id = 162 ;
explain options 'f' xx;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

---===== TEST BUILT-IN FUNCTION HQC Cacheability =====-------
-- CURRENT_TIMESTAMP - HQC cacheable and NOT parameterized
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CURRENT_TIMESTAMP (2);
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CURRENT_TIMESTAMP (3);
execute xx;
prepare xx from select CURRENT_TIMESTAMP (2) from t042_ORDERLINE where OL_D_ID = 3;
execute xx;
prepare xx from select CURRENT_TIMESTAMP (2) from t042_ORDERLINE where OL_D_ID = 4;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CURRENT_TIMESTAMP_RUNNING - HQC cacheable - no params
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CURRENT_TIMESTAMP_RUNNING and OL_D_ID = 3;
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CURRENT_TIMESTAMP_RUNNING and OL_D_ID = 5;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- dayofweek - HQC cacheable and parameterized
prepare xx from select dayofweek(timestamp '1973-12-24 12:12:02.00') from t042_ORDERLINE;
execute xx;
prepare xx from select dayofweek(timestamp '1975-12-24 12:12:02.00') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- EXTRACT - HQC cacheable and parameterized
prepare xx from select EXTRACT (YEAR FROM DATE '2017-09-28') from t042_ORDERLINE;
execute xx;
prepare xx from select EXTRACT (YEAR FROM DATE '1980-09-28') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- JULIANTIMESTAMP HQC cacheable and parameterized
prepare xx from select JULIANTIMESTAMP(DATE'2017-09-28') from t042_ORDERLINE;
execute xx;
prepare xx from select JULIANTIMESTAMP(DATE'1990-09-28') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- LOWER - HQC cacheable and NOT parameterized
prepare xx from select LOWER('TEXTA') from t042_ORDERLINE;
execute xx;
prepare xx from select LOWER('TEXTB') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- UPPER - HQC cacheable and NOT parameterized
prepare xx from select UPPER('ol_o_id_1') from t042_ORDERLINE;
execute xx;
prepare xx from select UPPER('ol_o_id_2') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- TRIM - HQC cacheable and NOT parameterized
prepare xx from select TRIM('L' FROM 'LO TE XTA') from t042_ORDERLINE;
execute xx;
prepare xx from select TRIM('A' FROM 'LO TE XTA') from t042_ORDERLINE;
execute xx;
prepare xx from select TRIM('  Robert1  ') from t042_ORDERLINE;
execute xx;
prepare xx from select TRIM('  Robert2  ') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- TRANSLATE - HQC cacheable and NOT parameterized
Prepare xx from select TRANSLATE(_iso88591'abc' using UCS2toISO88591) from t042_ORDERLINE;
execute xx;
Prepare xx from select TRANSLATE(_iso88591'abc' using UCS2toISO88591) from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CODE_VALUE - HQC cacheable and parameterized
prepare xx from select code_value ('aa'), * from t042_ORDERLINE;
execute xx;
prepare xx from select code_value ('bb'), * from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- BETWEEN - HQC cacheable but NOT parameterized
prepare xx from select * from t042_ORDERLINE where OL_NUMBER between 2 and 6;
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_NUMBER between 3 and 5;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- LIKE - HQC cacheable and only parameterize first arg
prepare xx from select * from t042_ORDERLINE  where OL_DIST_INFO like 'DoIQoq%';
execute xx;
prepare xx from select * from t042_ORDERLINE  where OL_DIST_INFO like 'DoIQ%';
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- IN - HQC cacheable and NOT parameterized
prepare xx from select * from t042_ORDERLINE  where OL_I_ID in (18000, 19000, 20000);
execute xx;
prepare xx from select * from t042_ORDERLINE  where OL_I_ID in (19500, 21000);
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CONCAT - HQC cacheable and NOT parameterized
prepare xx from select * from t042_ORDERLINE where 'DoIQoq' = concat(OL_DIST_INFO, 'abc');
execute xx;
prepare xx from select * from t042_ORDERLINE where 'xyzq' = concat(OL_DIST_INFO, 'bc');
execute xx;
prepare xx from select concat('a', 'b') from t042_ORDERLINE;
execute xx;
prepare xx from select concat('c', 'd') from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CONVERTTOHEX - HQC cacheable and NOT parameterized
prepare xx from select converttohex ('a'), * from t042_ORDERLINE;
execute xx;
prepare xx from select converttohex ('b'), * from t042_ORDERLINE;
execute xx;


sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CHAR_LENGTH - HQC cacheable and parameterized
prepare xx from select char_length ('a'), * from t042_ORDERLINE;
execute xx;
prepare xx from select char_length ('b'), * from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- OCTET_LENGTH - HQC cacheable and parameterized
prepare xx from select octet_length ('a'), * from t042_ORDERLINE;
execute xx;
prepare xx from select octet_length ('b'), * from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- POSITION - HQC cacheable and parameterized
prepare xx from select position('oIQo' in OL_DIST_INFO ) from t042_ORDERLINE;
execute xx;
prepare xx from select position('xyzoIQo' in OL_DIST_INFO ) from t042_ORDERLINE;
execute xx;
prepare xx from select * from t042_ORDERLINE where 2 = position('oIQo' in OL_DIST_INFO );
execute xx;
prepare xx from select * from t042_ORDERLINE where 9 = position('xyzoIQo' in OL_DIST_INFO );
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- SUBSTRING - HQC cacheable ONLY first arg is parameterized
prepare xx from select substring('aaaa'from 1 for 2) from t042_ORDERLINE;
execute xx;
prepare xx from select substring('abba'from 1 for 2) from t042_ORDERLINE;
execute xx;
prepare xx from select * from t042_ORDERLINE where 'DoIQoq' = substring(OL_DIST_INFO from 1 for 6);
execute xx;
prepare xx from select * from t042_ORDERLINE where 'DoIQoq' = substring(OL_DIST_INFO from 1 for 5);
execute xx;
prepare xx from select * from t042_ORDERLINE where 'DoIQoq' = substring('DoIQoqabc' from 1 for 5);
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CASE/IfThenElse - HQC cacheable and parameterized
prepare xx from select case when OL_O_ID <> 5 THEN 1 else 0 end from t042_ORDERLINE;
execute xx;
prepare xx from select case when OL_O_ID <> 6 THEN 2 else 1 end from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CAST - HQC cacheable and parameterize
prepare xx from select cast('aaa' as char(20)) from t042_ORDERLINE;
execute xx;
prepare xx from select cast('bbb' as char(30)) from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- bitOperator HQC cacheable and parameterized
prepare xx from select (1 | 0 )& (1 ^ 0) from t042_ORDERLINE;
execute xx;
prepare xx from select (2 | 1 )& (3 ^ 1) from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- MOD - HQC cacheable and parameterized
prepare xx from select mod(4,3) from t042_ORDERLINE;
execute xx;
prepare xx from select mod(8,5) from t042_ORDERLINE;
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_O_ID = mod(4,3);
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_O_ID = mod(8,5);
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- MATH FUNC - HQC cacheable and parameterized
prepare xx from select bitand(1,2), bitor(0,1), bitxor(0,0),bitnot(0), abs(-1) from t042_ORDERLINE;
execute xx;
prepare xx from select bitand(4,1), bitor(1,0), bitxor(1,1),bitnot(1), abs(-2) from t042_ORDERLINE;
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- CONVERTTIMESTAMP - HQC cacheable and parameterized
prepare xx from select CONVERTTIMESTAMP(212664316335000000) from t042_ORDERLINE;
execute xx;
prepare xx from select CONVERTTIMESTAMP(212842400938000000) from t042_ORDERLINE;
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CONVERTTIMESTAMP(212664316335000000);
execute xx;
prepare xx from select * from t042_ORDERLINE where OL_DELIVERY_D = CONVERTTIMESTAMP(212842400938000000);
execute xx;

sh cat hqc.log >> LOG042;
sh rm hqc.log;

-- test compile time

set statistics on;
prepare xx from select * from t042_orderline where ol_o_id = 1 ;
explain options 'f' xx;
sh cat hqc.log >> LOG042;
sh rm hqc.log;



prepare xx from select * from t042_orderline where ol_o_id = 2 ;
explain options 'f' xx;
sh cat hqc.log >> LOG042;
sh rm hqc.log;

set statistics off;

--Stats in Query Cache
select num_entries, num_plans from table(querycache('user', 'local'));
select num_entries, num_plans from table(querycache('meta', 'local'));
select num_entries, num_plans from table(querycache('all', 'local'));

select  plan_length, num_hits, num_params from table(querycacheentries('user', 'local')) order by 1;
select  plan_length, num_hits, num_params from table(querycacheentries('meta', 'local')) order by 1;
select  plan_length, num_hits, num_params from table(querycacheentries('all', 'local')) order by 1;


--Stats in Hybrid Query Cache
select * from table(hybridquerycache('user', 'local'));
select * from table(hybridquerycache('meta', 'local'));
select * from table(hybridquerycache('all', 'local'));

select char_length(hkey), num_hits, num_PLiterals,  num_NPLiterals from table(hybridquerycacheentries('user', 'local')) order by 1;
select char_length(hkey), num_hits,  num_PLiterals,  num_NPLiterals from table(hybridquerycacheentries('meta', 'local')) order by 1;
select char_length(hkey), num_hits, num_PLiterals,  num_NPLiterals from table(hybridquerycacheentries('all', 'local')) order by 1;


-- virtual table ISP queries are not cacheable.
-- hqc.log should be empty.
sh cat hqc.log >> LOG042;
sh rm hqc.log;

log off;

