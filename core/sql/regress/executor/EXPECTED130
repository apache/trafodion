>>obey TEST130(setup);
>>log;
>>create schema trafodion.lob130;

--- SQL operation complete.
>>set schema trafodion.lob130;

--- SQL operation complete.
>>create table t130lob1 (c1 blob);

--- SQL operation complete.
>>create table t130lob2 (c1 int not null, c2 blob , primary key (c1));

--- SQL operation complete.
>>create table t130lob3 (c1 int not null,
+>c2 blob, c3 blob, primary key (c1));

--- SQL operation complete.
>>create table t130lob4 (c1 int not null,
+>c2 char(10), c3 clob, primary key (c1));

--- SQL operation complete.
>>
>>
>>obey TEST130(dml_insert);
>>insert into t130lob1 values(NULL);

--- 1 row(s) inserted.
>>select * from t130lob1;

C1
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

--- 1 row(s) selected.
>>
>>insert into t130lob2 values(1,stringtolob('inserted row11'));

--- 1 row(s) inserted.
>>insert into t130lob2 values(2,stringtolob('inserted row12'));

--- 1 row(s) inserted.
>>insert into t130lob2 values(3,stringtolob('inserted row13'));

--- 1 row(s) inserted.
>>insert into t130lob2 values(3,stringtolob('xxxx'));

*** ERROR[8102] The operation is prevented by a unique constraint.

--- 0 row(s) inserted.
>>select * from t130lob2;

C1           C2
-----------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

          1  LOBH00000200010200982774330343097219200982774335666384818212328542081589586020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
          2  LOBH00000200010200982774330343097219200982774336230243318212328542087163180020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
          3  LOBH00000200010200982774330343097219200982774336733971718212328542092274951020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

--- 3 row(s) selected.
>>
>>
>>select lobtostring(c2,10) from t130lob2;

(EXPR)    
----------

inserted r
inserted r
inserted r

--- 3 row(s) selected.
>>select lobtostring(c2,2) from t130lob2;

(EXPR)
------

in    
in    
in    

--- 3 row(s) selected.
>>select c1,lobtostring(c2,100) from t130lob2;

C1           (EXPR)
-----------  ----------------------------------------------------------------------------------------------------

          1  inserted row11                                                                                      
          2  inserted row12                                                                                      
          3  inserted row13                                                                                      

--- 3 row(s) selected.
>>
>>
>>obey TEST130(dml_join);
>>insert into t130lob3 values (1,stringtolob('inserted row21a'),stringtolob('inserted row21b'));

--- 1 row(s) inserted.
>>insert into t130lob3 values (2,stringtolob('inserted row22a'),stringtolob('inserted row22b'));

--- 1 row(s) inserted.
>>insert into t130lob3 values (3,stringtolob('inserted row23a'),stringtolob('inserted row23b'));

--- 1 row(s) inserted.
>>insert into t130lob3 values (4,stringtolob('inserted row24a'),stringtolob('inserted row24b'));

--- 1 row(s) inserted.
>>
>>prepare s from 
+>select c1, lobtostring(c2,25), lobtostring(c3,25)  from t130lob3;

--- SQL command prepared.
>>
>>
>>
>>select lobtostring(t130lob2.c2,30) from t130lob2, t130lob3 where t130lob2.c1 = t130lob3.c1;

(EXPR)                        
------------------------------

inserted row11                
inserted row12                
inserted row13                

--- 3 row(s) selected.
>>
>>
>>
>>obey TEST130(dml_update);
>>
>>update t130lob2 set c2=stringtolob('updated c2 in all rows');

--- 3 row(s) updated.
>>select c1, lobtostring(c2,30) from t130lob2;

C1           (EXPR)                        
-----------  ------------------------------

          1  updated c2 in all rows        
          2  updated c2 in all rows        
          3  updated c2 in all rows        

--- 3 row(s) selected.
>>
>>update t130lob2 set c2=stringtolob('updated row21a') where c1=1;

--- 1 row(s) updated.
>>select c1, lobtostring(c2,30) from t130lob2;

C1           (EXPR)                        
-----------  ------------------------------

          1  updated row21a                
          2  updated c2 in all rows        
          3  updated c2 in all rows        

--- 3 row(s) selected.
>>select c1, lobtostring(c2,30) from t130lob2 where c1=1;

C1           (EXPR)                        
-----------  ------------------------------

          1  updated row21a                

--- 1 row(s) selected.
>>
>>obey TEST130(dml_update_append);
>>
>>update t130lob2 set c2=stringtolob('appended row21a',append) where c1=1;

--- 1 row(s) updated.
>>select c1, lobtostring(c2,100) from t130lob2;

C1           (EXPR)
-----------  ----------------------------------------------------------------------------------------------------

          1  updated row21aappended row21a                                                                       
          2  updated c2 in all rows                                                                              
          3  updated c2 in all rows                                                                              

--- 3 row(s) selected.
>>select c1, lobtostring(c2,100) from t130lob2 where c1=1;

C1           (EXPR)
-----------  ----------------------------------------------------------------------------------------------------

          1  updated row21aappended row21a                                                                       

--- 1 row(s) selected.
>>
>>
>>update t130lob2 set c2=stringtolob(' appended c2 to all rows',append);

--- 3 row(s) updated.
>>select c1, lobtostring(c2,60) from t130lob2;

C1           (EXPR)
-----------  ------------------------------------------------------------

          1  updated row21aappended row21a appended c2 to all rows       
          2  updated c2 in all rows appended c2 to all rows              
          3  updated c2 in all rows appended c2 to all rows              

--- 3 row(s) selected.
>>
>>obey TEST130(dml_delete);
>>
>>delete from t130lob3 where c1=1;

--- 1 row(s) deleted.
>>select c1, lobtostring(c2,30), lobtostring(c3,30)  from t130lob3;

C1           (EXPR)                          (EXPR)
-----------  ------------------------------  ------------------------------

          2  inserted row22a                 inserted row22b               
          3  inserted row23a                 inserted row23b               
          4  inserted row24a                 inserted row24b               

--- 3 row(s) selected.
>>
>>delete from t130lob2 ;

--- 3 row(s) deleted.
>>select * from t130lob2;

--- 0 row(s) selected.
>>log;
>>--setup
>>sh echo "Test for file input and extract";
>>create table tlob130txt1 (c1 int not null, c2 clob, primary key (c1));

--- SQL operation complete.
>>create table tlob130bin1 (c1 int not null, c2 blob, primary key (c1));

--- SQL operation complete.
>>create table tlob130txt_limit50(c1 int not null, c2 clob(50), primary key (c1));

--- SQL operation complete.
>>create table tlob130bin_limit1K(c1 int not null, c2 blob(1 K), primary key (c1));

--- SQL operation complete.
>>
>>sh cp $scriptsdir/executor/deep.jpg $rundir/executor/;
>>sh cp $scriptsdir/executor/anoush.jpg $rundir/executor/;
>>sh cp $scriptsdir/executor/lob_input_* $rundir/executor/;
>>sh cp $scriptsdir/executor/TEST130_argfile $rundir/executor/;
>>-- inserts
>>-- first line
>>insert into tlob130txt1 values (1, filetolob('lob_input_a1.txt'));

--- 1 row(s) inserted.
>>
>>-- second line
>>insert into tlob130txt1 values (2, filetolob('lob_input_b1.txt'));

--- 1 row(s) inserted.
>>
>>-- third line
>>insert into tlob130txt1 values (3, filetolob('lob_input_c1.txt'));

--- 1 row(s) inserted.
>>
>>select lobtostring(c2, 40 ) from tlob130txt1;

(EXPR)                                  
----------------------------------------

Hey diddle diddle,
                     
The cat and the fiddle,
                
The cow jumped over the moon.
          

--- 3 row(s) selected.
>>
>>--updates
>>
>>--should update with full poem
>>update tlob130txt1 set c2=filetolob('lob_input_d1.txt', append) where c1 = 3;

--- 1 row(s) updated.
>>
>>select lobtostring(c2, 200 ) from tlob130txt1;

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Hey diddle diddle,
                                                                                                                                                                                     
The cat and the fiddle,
                                                                                                                                                                                
The cow jumped over the moon.
The little dog laughed,
To see such sport,

And the dish ran away with the spoon.
                                                                                        

--- 3 row(s) selected.
>>
>>-- should see wrong text in the last few lines
>>update tlob130txt1 set c2=filetolob('lob_input_e1.txt') where c1 =3 ;

--- 1 row(s) updated.
>>
>>select lobtostring(c2, 200 ) from tlob130txt1;

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Hey diddle diddle,
                                                                                                                                                                                     
The cat and the fiddle,
                                                                                                                                                                                
The little dog cried,
To see such sport,

And the dish ran away with the fork !
                                                                                                                        

--- 3 row(s) selected.
>>
>>--delete
>>
>>-- go back to having just the first  line. 
>>delete from tlob130txt1 where c1 =2;

--- 1 row(s) deleted.
>>delete from tlob130txt1 where c1 =3;

--- 1 row(s) deleted.
>>
>>--test limits
>>
>>insert into tlob130txt_limit50 values(1,filetolob('lob_input_e1.txt'));

*** ERROR[8442] Unable to access ExpLOBInterfaceInsert interface. Call to ExpLOBInterfaceInsert returned error LOB_MAX_LIMIT_ERROR(560). Error detail 0.

--- 0 row(s) inserted.
>>insert into tlob130bin_limit1K values(1,filetolob('anoush.jpg'));

*** ERROR[8442] Unable to access ExpLOBInterfaceInsert interface. Call to ExpLOBInterfaceInsert returned error LOB_MAX_LIMIT_ERROR(560). Error detail 0.

--- 0 row(s) inserted.
>>--test extract 
>>
>>log;
>>sh rm t130_extract_command;
>>
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'tlob130_txt1.txt');/g" >> t130_extract_command;
>>
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330346590219200982774370093833718212328542425748115020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'tlob130_txt1.txt');
Success. Targetfile :tlob130_txt1.txt  Length : 19

--- SQL operation complete.
>>
>>--binary input/update
>>
>>insert into tlob130bin1 values (1 , filetolob('deep.jpg'));

--- 1 row(s) inserted.
>>--extract // should have a viewable picture file
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'tlob130_deep.jpg');/g" >> t130_extract_command;
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330346651219200982774376837892918212328542493209860020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'tlob130_deep.jpg');
Success. Targetfile :tlob130_deep.jpg  Length : 159018

--- SQL operation complete.
>>
>>update tlob130bin1 set c2=filetolob('anoush.jpg') ;

--- 1 row(s) updated.
>>
>>--extract into a different file // should have a different viewable picture.
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'tlob130_anoush.jpg');/g" >> t130_extract_command;
>>
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330346651219200982774376837892918212328542493209860020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'tlob130_anoush.jpg');
Success. Targetfile :tlob130_anoush.jpg  Length : 230150

--- SQL operation complete.
>>
>>
>>
>>
>>-- Test for hdfs input
>>--cleanup -- comment the following lines out if you want to debug this test and save intermediate files.
>>obey TEST130(lob_hdfs_cleanup);
>>log;
>>create table tlob130txt2 (c1 int not null, c2 clob, primary key (c1));

--- SQL operation complete.
>>create table tlob130bin2 (c1 int not null, c2 blob, primary key (c1));

--- SQL operation complete.
>>
>>sh regrhadoop.ksh fs -copyFromLocal lob_input_a1.txt /lobs/lob_input_a1.txt;
>>sh regrhadoop.ksh fs -copyFromLocal lob_input_b1.txt /lobs/lob_input_b1.txt;
>>sh regrhadoop.ksh fs -copyFromLocal lob_input_c1.txt /lobs/lob_input_c1.txt;
>>sh regrhadoop.ksh fs -copyFromLocal lob_input_d1.txt /lobs/lob_input_d1.txt;
>>sh regrhadoop.ksh fs -copyFromLocal lob_input_e1.txt /lobs/lob_input_e1.txt;
>>sh regrhadoop.ksh fs -copyFromLocal deep.jpg /lobs/deep.jpg;
>>sh regrhadoop.ksh fs -copyFromLocal anoush.jpg /lobs/anoush.jpg;
>>sh sleep(20);
>>
>>
>>insert into tlob130txt2 values (1, filetolob('hdfs:///lobs/lob_input_a1.txt'));

--- 1 row(s) inserted.
>>
>>-- second line
>>insert into tlob130txt2 values (2, filetolob('hdfs:///lobs/lob_input_b1.txt'));

--- 1 row(s) inserted.
>>
>>-- third line
>>insert into tlob130txt2 values (3, filetolob('hdfs:///lobs/lob_input_c1.txt'));

--- 1 row(s) inserted.
>>select lobtostring(c2, 40 ) from tlob130txt2;

(EXPR)                                  
----------------------------------------

Hey diddle diddle,
                     
The cat and the fiddle,
                
The cow jumped over the moon.
          

--- 3 row(s) selected.
>>
>>--updates
>>
>>--should update with full poem
>>update tlob130txt2 set c2=filetolob('hdfs:///lobs/lob_input_d1.txt', append) where c1 = 3;

--- 1 row(s) updated.
>>select lobtostring(c2, 200 ) from tlob130txt2;

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Hey diddle diddle,
                                                                                                                                                                                     
The cat and the fiddle,
                                                                                                                                                                                
The cow jumped over the moon.
The little dog laughed,
To see such sport,

And the dish ran away with the spoon.
                                                                                        

--- 3 row(s) selected.
>>
>>-- should see wrong text in the last few lines
>>update tlob130txt2 set c2=filetolob('hdfs:///lobs/lob_input_e1.txt') where c1 =3 ;

--- 1 row(s) updated.
>>select lobtostring(c2, 200 ) from tlob130txt2;

(EXPR)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Hey diddle diddle,
                                                                                                                                                                                     
The cat and the fiddle,
                                                                                                                                                                                
The little dog cried,
To see such sport,

And the dish ran away with the fork !
                                                                                                                        

--- 3 row(s) selected.
>>
>>--delete
>>
>>
>>-- go back to having just the first  line. 
>>delete from tlob130txt2 where c1 =2;

--- 1 row(s) deleted.
>>delete from tlob130txt2 where c1 =3;

--- 1 row(s) deleted.
>>-- test extract 
>>
>>log;
>>sh rm t130_extract_command;
>>
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'hdfs:\/\/\/lobs\/tlob130_txt2.txt');/g" >> t130_extract_command;
>>
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330347819519200982774383085167918212328542555756185020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'hdfs:///lobs/tlob130_txt2.txt');
Success. Targetfile :hdfs:///lobs/tlob130_txt2.txt  Length : 19

--- SQL operation complete.
>>
>>--binary input/update
>>
>>insert into tlob130bin2 values (1 , filetolob('deep.jpg'));

--- 1 row(s) inserted.
>>--extract // should have a viewable picture file
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'hdfs:\/\/\/lobs\/tlob130_deep.jpg');/g" >> t130_extract_command;
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330347890419200982774389242411018212328542617280373020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'hdfs:///lobs/tlob130_deep.jpg');
Success. Targetfile :hdfs:///lobs/tlob130_deep.jpg  Length : 159018

--- SQL operation complete.
>>
>>update tlob130bin2 set c2=filetolob('anoush.jpg') ;

--- 1 row(s) updated.
>>
>>--extract into a different file // should have a different viewable picture.
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'hdfs:\/\/\/lobs\/tlob130_anoush.jpg');/g" >> t130_extract_command;
>>
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200010200982774330346651219200982774376837892918212328542493209860020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'hdfs:///lobs/tlob130_anoush.jpg');
Success. Targetfile :hdfs:///lobs/tlob130_anoush.jpg  Length : 230150

--- SQL operation complete.
>>
>>
>>sh clitestdriver 2 < TEST130_argfile 2>&1 | tee -a LOG130;
*************************************
Blob test extract to file in chunks 
************************************
Extract from a lob column in a lob table

Input lob table name :
Table name : TRAFODION.LOB130.tlob130bin1
Input lob column name to extract from :
Column Name : c2
Input a filename to extract to : 
Output File Name : lobc2out.jpg
Extracting  lob handle for column c2...
LOB handle for c2: LOBH00000200010200982774330346651219200982774376837892918212328542493209860020"TRAFODION"."LOB130"
Extracting LOB data length for the above handle...
LOB data length :230150
Extracting lob data into file in chunks of 1000 ...
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 1000 bytes to file : lobc2out.jpg
Wrote 150 bytes to file : lobc2out.jpg
>>
>>------------------------------------------------------------------------------
>>obey TEST130(lob_misc_cleanup);
>>log;
>>-- 2 clob columns
>>create table tlob130txt3 (c1 int not null, c2 int, c3 clob, c4 clob, primary key (c1));

--- SQL operation complete.
>>insert into tlob130txt3 values (1, 1,filetolob('lob_input_a1.txt'), filetolob('lob_input_b1.txt'));

--- 1 row(s) inserted.
>>insert into tlob130txt3 values (2, 2,filetolob('lob_input_c1.txt'), filetolob('lob_input_d1.txt'));

--- 1 row(s) inserted.
>>select lobtostring(c3,100), lobtostring(c4,100)from tlob130txt3;

(EXPR)                                                                                                (EXPR)
----------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------

Hey diddle diddle,
                                                                                   The cat and the fiddle,
                                                                            
The cow jumped over the moon.
                                                                        The little dog laughed,
To see such sport,

And the dish ran away with the spoon.
                  

--- 2 row(s) selected.
>>
>>-- 2 blob columns
>>create table tlob130bin3 (c1 int not null, c2 int, c3 blob, c4 blob, primary key (c1));

--- SQL operation complete.
>>insert into tlob130bin3 values (1, 1, filetolob('deep.jpg'), filetolob('anoush.jpg'));

--- 1 row(s) inserted.
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'tlob130_deep2.jpg');/g" >> t130_extract_command;
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200020200982774330349738319200982774400272091018212328542727572065020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'tlob130_deep2.jpg');
Success. Targetfile :tlob130_deep2.jpg  Length : 159018

--- SQL operation complete.
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'hdfs:\/\/\/lobs\/tlob130_anoush2.jpg');/g" >> t130_extract_command;
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200030200982774330349738319200982774400783874418212328542732607600020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'hdfs:///lobs/tlob130_anoush2.jpg');
Success. Targetfile :hdfs:///lobs/tlob130_anoush2.jpg  Length : 230150

--- SQL operation complete.
>>
>>-- combination blob and clob columns
>>create table tlob130bt (c1 int not null, c2 int, c3 blob, c4 clob, primary key (c1));

--- SQL operation complete.
>>insert into tlob130bt values (1,1, filetolob('lob_input_a1.txt'), filetolob('anoush.jpg'));

--- 1 row(s) inserted.
>>
>>select lobtostring(c3,40) from tlob130bt;

(EXPR)                                  
----------------------------------------

Hey diddle diddle,
                     

--- 1 row(s) selected.
>>
>>log;
>>sh rm t130_extract_command;
>>sh grep "^LOBH" TMP130 | sed "s/^/extract lobtofile(LOB '/g" | sed "s/$/' , 'tlob130_anoush3.jpg',create,truncate);/g" >> t130_extract_command;
>>obey t130_extract_command;
>>extract lobtofile(LOB 'LOBH00000200030200982774330350112719200982774404493754218212328542769759826020"TRAFODION"."LOB130"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ' , 'tlob130_anoush3.jpg',create,truncate);
Success. Targetfile :tlob130_anoush3.jpg  Length : 230150

--- SQL operation complete.
>>
>>obey TEST130(lob_gc_cleanup);
>>log;
>>create table tlob130gc (c1 int not null, c2 blob, c3 blob, primary key (c1));

--- SQL operation complete.
>>--insert a few rows
>>insert into tlob130gc values (1, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (2, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (3, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (4, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (5, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (6, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (7, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>insert into tlob130gc values (8, stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>--create holes in the lob data file
>>delete from tlob130gc where c1=2;

--- 1 row(s) deleted.
>>delete from tlob130gc where c1=6;

--- 1 row(s) deleted.
>>update tlob130gc set c2=stringtolob('xxxx')where c1=7;

--- 1 row(s) updated.
>>--check contents of table
>>select c1,lobtostring(c2,10),lobtostring(c3,10) from tlob130gc;

C1           (EXPR)      (EXPR)    
-----------  ----------  ----------

          1  aaaa        bbbbb     
          3  aaaa        bbbbb     
          4  aaaa        bbbbb     
          5  aaaa        bbbbb     
          7  xxxx        bbbbb     
          8  aaaa        bbbbb     

--- 6 row(s) selected.
>>cqd LOB_GC_LIMIT_SIZE '0';

--- SQL operation complete.
>>--this next insert should trigger a GC
>>insert into tlob130gc values(9,stringtolob('aaaa'), stringtolob('bbbbb'));

--- 1 row(s) inserted.
>>--check contents of table. Should have one extra row compared to above select
>>select c1,lobtostring(c2,10),lobtostring(c3,10) from tlob130gc;

C1           (EXPR)      (EXPR)    
-----------  ----------  ----------

          1  aaaa        bbbbb     
          3  aaaa        bbbbb     
          4  aaaa        bbbbb     
          5  aaaa        bbbbb     
          7  xxxx        bbbbb     
          8  aaaa        bbbbb     
          9  aaaa        bbbbb     

--- 7 row(s) selected.
>>cqd LOB_GC_LIMIT_SIZE reset;

--- SQL operation complete.
>>
>>obey TEST130(lob_get_cleanup);
>>log;
>>create table tlob130gt (c1 int not null, c2 blob, c3 clob, c4 blob, primary key (c1));

--- SQL operation complete.
>>insert into tlob130gt values (1, stringtolob('xxxx'), stringtolob('yyyy'), stringtolob('zzzzzzzzzzzzzz'));

--- 1 row(s) inserted.
>>insert into tlob130gt values (2, stringtolob('xxxxx'), stringtolob('yyyyy'), stringtolob('zzzzzzzzzzzzzzz'));

--- 1 row(s) inserted.
>>insert into tlob130gt values (3, stringtolob('xxxxxx'), stringtolob('yyyyyy'), stringtolob('zzzzzzzzzzzzzzzz'));

--- 1 row(s) inserted.
>>get lob stats for table tlob130gt;


Lob Information for table: "TRAFODION".LOB130.TLOB130GT
=========================

  ColumnName :  C2
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0001
  LOB EOD :  15
  LOB Used Len :  15
  ColumnName :  C3
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0002
  LOB EOD :  15
  LOB Used Len :  15
  ColumnName :  C4
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0003
  LOB EOD :  45
  LOB Used Len :  45

--- SQL operation complete.
>>select * from table(lob stats(tlob130gt));

CATALOG_NAME                                                                                                                                                                                                                                                      SCHEMA_NAME                                                                                                                                                                                                                                                       OBJECT_NAME                                                                                                                                                                                                                                                       COLUMN_NAME                                                                                                                                                                                                                                                       LOB_LOCATION                                                                                                                                                                                                                                                      LOB_DATA_FILE                                                                                                                                                                                                                                                     LOB_DATA_FILE_SIZE_EOD  LOB_DATA_FILE_SIZE_USED
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------  -----------------------

TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C2                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0001                                                                                                                                                                                                                                                        15                       15
TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C3                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0002                                                                                                                                                                                                                                                        15                       15
TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C4                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0003                                                                                                                                                                                                                                                        45                       45

--- 3 row(s) selected.
>>delete from tlob130gt where c1=2;

--- 1 row(s) deleted.
>>insert into tlob130gt values (2, stringtolob('xxxxxxxxxxxxxxx'), stringtolob('yyyyyyyyyyyyyyyy'), stringtolob('zzzzzzzzzzzzzzzzzzzzzzzzzz'));

--- 1 row(s) inserted.
>>get lob stats for table tlob130gt;


Lob Information for table: "TRAFODION".LOB130.TLOB130GT
=========================

  ColumnName :  C2
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0001
  LOB EOD :  30
  LOB Used Len :  25
  ColumnName :  C3
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0002
  LOB EOD :  31
  LOB Used Len :  26
  ColumnName :  C4
  Lob Location :  /lobs
  LOB Data File:  LOBP_02009827743303525717_0003
  LOB EOD :  71
  LOB Used Len :  56

--- SQL operation complete.
>>select * from table(lob stats(tlob130gt));

CATALOG_NAME                                                                                                                                                                                                                                                      SCHEMA_NAME                                                                                                                                                                                                                                                       OBJECT_NAME                                                                                                                                                                                                                                                       COLUMN_NAME                                                                                                                                                                                                                                                       LOB_LOCATION                                                                                                                                                                                                                                                      LOB_DATA_FILE                                                                                                                                                                                                                                                     LOB_DATA_FILE_SIZE_EOD  LOB_DATA_FILE_SIZE_USED
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  ----------------------  -----------------------

TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C2                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0001                                                                                                                                                                                                                                                        30                       25
TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C3                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0002                                                                                                                                                                                                                                                        31                       26
TRAFODION                                                                                                                                                                                                                                                         LOB130                                                                                                                                                                                                                                                            TLOB130GT                                                                                                                                                                                                                                                         C4                                                                                                                                                                                                                                                                /lobs                                                                                                                                                                                                                                                             LOBP_02009827743303525717_0003                                                                                                                                                                                                                                                        71                       56

--- 3 row(s) selected.
>>
>>-- test to ensure all lob dependent tables and schemas containing lob tables
>>-- get dropped cleanly.
>>obey TEST130(lob_drop_table_schema);
>>log;
>>create schema trafodion.lobsch;

--- SQL operation complete.
>>set schema trafodion.lobsch;

--- SQL operation complete.
>>create table tlob130ts1 (c1 int not null, c2 blob, primary key (c1));

--- SQL operation complete.
>>create table tlob130ts2 (c1 int not null, c2 blob, primary key (c1));

--- SQL operation complete.
>>drop table tlob130ts1;

--- SQL operation complete.
>>get tables;

Tables in Schema TRAFODION.LOBSCH
=================================

LOBDescChunks__02009827743303536445_0001
LOBDescHandle__02009827743303536445_0001
LOBMD__02009827743303536445
SB_HISTOGRAMS
SB_HISTOGRAM_INTERVALS
TLOB130TS2

--- SQL operation complete.
>>drop schema trafodion.lobsch cascade;

--- SQL operation complete.
>>select OBJECT_NAME,OBJECT_TYPE from TRAFODION."_MD_".OBJECTS where catalog_name='TRAFODION' AND schema_name='LOBSCH';

--- 0 row(s) selected.
>>--go back to the schema used for the rest of the tests.
>>set schema trafodion.lob130;

--- SQL operation complete.
>>
>>
>>obey TEST130(lob_general_cleanup);
>>log;
